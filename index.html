// Configuraci√≥n de Google Drive API
        const CLIENT_ID = '976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDSMWMM3lJM4ZNqRezhH-8uxaE1GVOjrrM';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DATA_FILE_NAME = 'datos_planilla_siniestros.json';
        const DOCS_FOLDER_NAME = 'Planilla_Siniestros_Documentos';

        let tokenClient, gapiInited = false, gisInited = false, dataFileId = null, docsFolderId = null;
        
        function gapiLoaded() { 
            gapi.load('client', initializeGapiClient); 
        }
        
        async function initializeGapiClient() { 
            await gapi.client.init({ 
                apiKey: API_KEY, 
                discoveryDocs: [DISCOVERY_DOC] 
            }); 
            gapiInited = true; 
            maybeEnableButtons(); 
        }
        
        function gisLoaded() { 
            tokenClient = google.accounts.oauth2.initTokenClient({ 
                client_id: CLIENT_ID, 
                scope: SCOPES, 
                callback: '' 
            }); 
            gisInited = true; 
            maybeEnableButtons(); 
        }
        
        function maybeEnableButtons() { 
            if (gapiInited && gisInited) {
                const connectBtn = document.getElementById('connectDriveBtn');
                if (connectBtn) {
                    connectBtn.onclick = handleAuthClick;
                }
            }
        }
        
        function updateDriveStatus(message, isConnected = false) { 
            const driveStatusEl = document.getElementById('driveStatus');
            if (driveStatusEl) {
                driveStatusEl.style.display = 'block'; 
                driveStatusEl.textContent = message; 
                driveStatusEl.style.background = isConnected ? '#d1e7dd' : '#fff3cd'; 
                driveStatusEl.style.color = isConnected ? '#0f5132' : '#664d03';
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw (resp);
                updateDriveStatus('‚úÖ Conectado a Google Drive', true);
                
                const connectBtn = document.getElementById('connectDriveBtn');
                const saveBtn = document.getElementById('saveToDriveBtn');
                const loadBtn = document.getElementById('loadFromDriveBtn');
                
                if (connectBtn) connectBtn.style.display = 'none'; 
                if (saveBtn) {
                    saveBtn.style.display = 'inline-block';
                    saveBtn.onclick = saveDataToDrive;
                }
                if (loadBtn) {
                    loadBtn.style.display = 'inline-block';
                    loadBtn.onclick = loadDataFromDrive;
                }
                
                await findDataFile();
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function findDataFile() {
            updateDriveStatus('Buscando archivo de datos...', false);
            try {
                const response = await gapi.client.drive.files.list({ 
                    q: `name='${DATA_FILE_NAME}' and trashed=false`, 
                    fields: 'files(id, name)', 
                    spaces: 'drive' 
                });
                
                if (response.result.files.length > 0) { 
                    dataFileId = response.result.files[0].id; 
                    updateDriveStatus('‚úÖ Archivo de datos encontrado.', true); 
                } else { 
                    updateDriveStatus('‚ö†Ô∏è Archivo no encontrado. Se crear√° uno nuevo al guardar.', false); 
                    dataFileId = null; 
                }
            } catch (err) { 
                console.error(err); 
                alert('Error al buscar el archivo de datos.'); 
            }
        }
        
        async function saveDataToDrive() {
            if (!confirm('¬øGuardar los datos actuales en Google Drive?')) return;
            updateDriveStatus('Guardando datos en Drive...', false);
            const content = JSON.stringify(siniestrosData, null, 2);
            try {
                const fileMetadata = await uploadFileContent(content, DATA_FILE_NAME, 'application/json', null, dataFileId);
                dataFileId = fileMetadata.id;
                updateDriveStatus('‚úÖ ¬°Datos guardados en Drive con √©xito!', true);
            } catch (err) { 
                console.error(err); 
                updateDriveStatus('‚ùå Error al guardar en Drive.', false); 
            }
        }
        
        async function loadDataFromDrive() {
            if (!dataFileId) {
                return alert("No se ha encontrado un archivo de datos. Guarda primero para crear uno.");
            }
            if (!confirm("¬øSeguro? Se reemplazar√°n los datos actuales con los de Drive.")) return;
            updateDriveStatus('Cargando datos desde Drive...', false);
            try {
                const response = await gapi.client.drive.files.get({ 
                    fileId: dataFileId, 
                    alt: 'media' 
                });
                const importedData = JSON.parse(response.body);
                if (!Array.isArray(importedData)) throw new Error('Formato no v√°lido.');
                siniestrosData = sanitizeData(importedData); 
                saveData(); 
                renderAll();
                updateDriveStatus('‚úÖ Datos cargados desde Drive con √©xito.', true);
            } catch (err) { 
                console.error(err); 
                updateDriveStatus('‚ùå Error al cargar desde Drive.', false); 
            }
        }
        
        async function getOrCreateFolder(name, parentId = null) {
            let query = `mimeType='application/vnd.google-apps.folder' and name='${name}' and trashed=false`;
            if (parentId) query += ` and '${parentId}' in parents`;
            const response = await gapi.client.drive.files.list({ 
                q: query, 
                fields: 'files(id)' 
            });
            if (response.result.files.length > 0) return response.result.files[0].id;
            
            const fileMetadata = { 
                name, 
                mimeType: 'application/vnd.google-apps.folder' 
            };
            if (parentId) fileMetadata.parents = [parentId];
            const newFolder = await gapi.client.drive.files.create({ 
                resource: fileMetadata, 
                fields: 'id' 
            });
            return newFolder.result.id;
        }
        
        async function loadDriveDocuments(siniestroId) {
            if (!gapi.client || gapi.client.getToken() === null) return;
            
            const siniestro = siniestrosData.find(s => s.id === siniestroId);
            if (!siniestro) return;
            
            const listEl = document.getElementById('documentList');
            try {
                if (!docsFolderId) {
                    docsFolderId = await getOrCreateFolder(DOCS_FOLDER_NAME);
                }
                const clientFolderName = `${siniestro.cliente.replace(/[\/\\?%*:|"<>]/g, '-')}_${siniestro.dni || siniestro.id.slice(-4)}`;
                const clientFolderId = await getOrCreateFolder(clientFolderName, docsFolderId);
                
                const response = await gapi.client.drive.files.list({ 
                    q: `'${clientFolderId}' in parents and trashed=false`, 
                    fields: 'files(id, name, webViewLink)' 
                });
                
                listEl.innerHTML = response.result.files.length === 0 ? 
                    '<li>No hay documentos.</li>' : 
                    response.result.files.map(file => 
                        `<li>
                            <a href="${file.webViewLink}" target="_blank">${file.name}</a>
                            <button class="btn btn-danger btn-sm" onclick="deleteDocument('${file.id}')">X</button>
                        </li>`
                    ).join('');
            } catch (err) { 
                console.error(err); 
                listEl.innerHTML = '<li>Error al cargar documentos.</li>'; 
            }
        }
        
        async function deleteDocument(fileId) { 
            if (confirm('¬øEliminar este documento?')) {
                try { 
                    await gapi.client.drive.files.delete({ fileId }); 
                    loadDriveDocuments(currentSiniestroIdForDocs); 
                } catch (err) { 
                    alert('Error al eliminar.'); 
                } 
            }
        }
        
        function triggerDocumentUpload() { 
            const uploader = document.getElementById('documentUploadInput'); 
            uploader.onchange = handleDocumentUpload; 
            uploader.value = ''; 
            uploader.click(); 
        }
        
        async function handleDocumentUpload(event) {
            const file = event.target.files[0]; 
            if (!file) return;
            const listEl = document.getElementById('documentList');
            listEl.innerHTML = '<div class="spinner"></div><p style="text-align:center;">Subiendo...</p>';
            try {
                if (!docsFolderId) {
                    docsFolderId = await getOrCreateFolder(DOCS_FOLDER_NAME);
                }
                const siniestro = siniestrosData.find(s => s.id === currentSiniestroIdForDocs);
                const clientFolderName = `${siniestro.cliente.replace(/[\/\\?%*:|"<>]/g, '-')}_${siniestro.dni || siniestro.id.slice(-4)}`;
                const clientFolderId = await getOrCreateFolder(clientFolderName, docsFolderId);
                
                const reader = new FileReader();
                reader.onload = async (e) => { 
                    await uploadFileContent(e.target.result, file.name, file.type, clientFolderId, null); 
                    loadDriveDocuments(currentSiniestroIdForDocs); 
                };
                reader.readAsArrayBuffer(file);
            } catch (err) { 
                console.error(err); 
                alert("Error al subir."); 
                loadDriveDocuments(currentSiniestroIdForDocs); 
            }
        }
        
        function uploadFileContent(content, fileName, mimeType, parentId, fileIdToUpdate) {
            let contentToUpload, contentTypeForRequest;
            if (typeof content === 'string') { 
                contentToUpload = content; 
                contentTypeForRequest = mimeType; 
            } else { 
                contentToUpload = new Uint8Array(content).reduce((data, byte) => data + String.fromCharCode(byte), ''); 
                contentTypeForRequest = mimeType; 
            }
            
            const boundary = '-------314159265358979323846';
            const delimiter = `\r\n--${boundary}\r\n`;
            const close_delim = `\r\n--${boundary}--`;
            
            const metadata = { 
                name: fileName, 
                mimeType: mimeType 
            };
            if (parentId) metadata.parents = [parentId];
            
            const multipartRequestBody = delimiter + 
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' + 
                JSON.stringify(metadata) + delimiter + 
                `Content-Type: ${contentTypeForRequest}\r\n` + 
                (typeof content === 'string' ? '' : 'Content-Transfer-Encoding: base64\r\n') + 
                '\r\n' + 
                (typeof content === 'string' ? contentToUpload : btoa(contentToUpload)) + 
                close_delim;
                
            const path = fileIdToUpdate ? `/upload/drive/v3/files/${fileIdToUpdate}` : '/upload/drive/v3/files';
            const method = fileIdToUpdate ? 'PATCH' : 'POST';
            
            return gapi.client.request({ 
                path: path, 
                method: method, 
                params: { uploadType: 'multipart' }, 
                headers: { 'Content-Type': `multipart/related; boundary=${boundary}` }, 
                body: multipartRequestBody 
            }).then(response => response.result);
        }<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla de Siniestros - Garc√≠a & Asociados</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .main-content { padding: 30px; }
        .dashboard {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px; margin-bottom: 40px;
        }
        .card {
            background: white; border-radius: 12px; padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        .card h3 {
            color: #2c3e50; margin-bottom: 20px; font-size: 1.3em;
            display: flex; align-items: center; gap: 10px;
        }
        .icon { width: 24px; height: 24px; fill: currentColor; }
        .today-reviews { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; }
        .overdue-reviews { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; }
        .pending-reviews { background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%); color: white; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 12px 24px; border-radius: 8px;
            cursor: pointer; font-size: 1em; transition: all 0.3s ease; margin: 5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .btn-info { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .btn-sm { padding: 8px 16px; font-size: 0.9em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 1em; transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .reviews-list { max-height: 400px; overflow-y: auto; }
        .review-item {
            background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px;
            margin-bottom: 10px; border-radius: 0 8px 8px 0; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 10px;
        }
        .review-item-content { flex-grow: 1; cursor: pointer; }
        .review-item.completed .review-item-content { text-decoration: line-through; opacity: 0.6; }
        .review-item.completed { border-left-color: #2ecc71; background-color: #f2fdf5; }
        .review-item:hover { background: #e8f2ff; transform: translateX(5px); }
        .review-item.today { border-left-color: #e74c3c; background: #fff5f5; }
        .review-item.overdue { border-left-color: #f39c12; background: #fef9e7; }
        .review-date { font-weight: 600; color: #2c3e50; font-size: 1.1em; }
        .review-client { font-size: 1em; color: #667eea; margin: 5px 0; }
        .review-obs { font-size: 0.9em; color: #666; font-style: italic; }
        .complete-btn {
            background: #e0e0e0; border: none; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; transition: all 0.3s ease;
            font-size: 16px; flex-shrink: 0;
        }
        .complete-btn:hover { background: #c0c0c0; }
        .review-item.completed .complete-btn { background: #2ecc71; color: white; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: white; border-radius: 15px; padding: 30px; width: 95%;
            max-width: 900px; max-height: 90vh; overflow-y: auto; animation: modalSlide 0.3s ease;
        }
        @keyframes modalSlide { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .client-info { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .client-info h4 { color: #2c3e50; margin-bottom: 15px; font-size: 1.2em; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .info-grid.full-width > .info-item { grid-column: 1 / -1; }
        .info-item { background: white; padding: 12px; border-radius: 5px; border-left: 3px solid #667eea; }
        .info-label { font-size: 0.8em; color: #666; text-transform: uppercase; font-weight: 600; }
        .info-value { font-size: 1em; color: #2c3e50; margin-top: 2px; font-weight: 500; }
        .editable-field { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background-color 0.3s ease; min-height: 20px; }
        .editable-field:hover { background-color: #e8f4fd; color: #2980b9; }
        .observations-history { margin-top: 20px; }
        .obs-item { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; }
        .obs-date { font-size: 0.9em; color: #667eea; font-weight: 600; margin-bottom: 5px; }
        .obs-text { color: #2c3e50; }
        .obs-revision-date { font-size: 0.8em; color: #c0392b; margin-top: 5px; font-weight: 500; }
        .close { float: right; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
        .close:hover { color: #333; }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; justify-content: center; }
        .data-status {
            background: #d4edda; border: 1px solid #c3e6cb; color: #155724;
            padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center;
        }
        .filter-bar {
            background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
        }
        .form-section { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .form-section h4 { color: #2c3e50; margin-bottom: 15px; font-size: 1.2em; }
        .document-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        .document-list li { background: #f1f3f5; padding: 10px; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .document-list a { color: #3498db; text-decoration: none; font-weight: 500; word-break: break-all; }
        .document-list a:hover { text-decoration: underline; }
        .document-list .btn-sm { flex-shrink: 0; margin-left: 10px; }
        .document-list .spinner { display: block; margin: 20px auto; width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .dashboard, .filter-bar, .info-grid { grid-template-columns: 1fr; } .main-content { padding: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Planilla de Siniestros</h1>
            <p>Garc√≠a & Asociados - Gesti√≥n de Reclamos y Seguros</p>
        </div>

        <div class="main-content">
            <div id="dataStatus" class="data-status">Cargando datos...</div>
            <div id="driveStatus" class="data-status" style="margin-top: -10px; display: none;"></div>

            <!-- DASHBOARD DE TAREAS -->
            <div class="dashboard">
                <div class="card today-reviews">
                    <h3><svg class="icon" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>Revisiones de Hoy</h3>
                    <div class="reviews-list" id="todayReviews"></div>
                </div>
                <div class="card overdue-reviews">
                    <h3><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>Revisiones Vencidas</h3>
                    <div class="reviews-list" id="overdueReviews"></div>
                </div>
                <div class="card pending-reviews">
                    <h3><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>Pr√≥ximas Revisiones</h3>
                    <div class="reviews-list" id="upcomingReviews"></div>
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 30px;">
                <button class="btn btn-success" onclick="showNewSiniestroModal()">‚ûï Agregar Siniestro</button>
                <button class="btn" onclick="showSiniestroSelectorModal()">üëÅÔ∏è Ver/Editar Siniestro</button>
                <button class="btn" onclick="exportToExcel()">üìä Exportar a Excel</button>
                <button class="btn" onclick="exportData()">üíæ Exportar JSON</button>
                <button class="btn btn-warning" onclick="importData()">üì• Importar Datos</button>
            </div>
            
            <!-- BOTONES DE GOOGLE DRIVE -->
            <div style="text-align: center; margin-bottom: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
                <button id="connectDriveBtn" class="btn">üîó Conectar a Drive</button>
                <button id="saveToDriveBtn" class="btn btn-success" style="display:none;">üì§ Guardar en Drive</button>
                <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;">üì• Cargar de Drive</button>
            </div>

            <div class="filter-bar">
                <div class="form-group"><label>B√∫squeda General</label><input type="text" id="searchInput" placeholder="Buscar por cliente, DNI, reclamo, etc." onkeyup="renderAllSiniestrosList()"></div>
                <div class="form-group"><label>Filtrar por Estado</label><select id="estadoFilter" onchange="renderAllSiniestrosList()"><option value="">Todos los estados</option><option value="RECHAZADO">Rechazado</option><option value="FINALIZADA">Finalizada</option><option value="FINALIZADA P">Finalizada P</option><option value="EJECUCION">Ejecuci√≥n</option><option value="DEMORADA">Demorada</option></select></div>
            </div>

            <div class="card">
                <h3>üìã Todos los Siniestros (Ordenados por fecha de revisi√≥n)</h3>
                <div class="reviews-list" id="allSiniestros" style="max-height: 600px;"></div>
            </div>
        </div>
    </div>

    <input type="file" id="importInput" accept=".json" style="display: none;" onchange="handleImport(event)">
    <input type="file" id="documentUploadInput" style="display: none;">

    <!-- MODALES -->
    <div id="newSiniestroModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newSiniestroModal')">&times;</span>
            <h2>‚ûï Agregar Nuevo Siniestro</h2>
            <form id="newSiniestroForm">
                <div class="info-grid">
                    <div class="form-group">
                        <label>Cliente *</label>
                        <input type="text" id="newCliente" required>
                    </div>
                    <div class="form-group">
                        <label>DNI</label>
                        <input type="number" id="newDni">
                    </div>
                    <div class="form-group">
                        <label>Celular</label>
                        <input type="tel" id="newCelular">
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select id="newEstado" required>
                            <option value="EJECUCION">En Ejecuci√≥n</option>
                            <option value="FINALIZADA">Finalizada</option>
                            <option value="FINALIZADA P">Finalizada P</option>
                            <option value="RECHAZADO">Rechazado</option>
                            <option value="DEMORADA">Demorada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Asegurado En</label>
                        <input type="text" id="newAseguradoEn">
                    </div>
                    <div class="form-group">
                        <label>Contra</label>
                        <input type="text" id="newContra">
                    </div>
                    <div class="form-group">
                        <label>N¬∞ Reclamo</label>
                        <input type="text" id="newNumeroReclamo">
                    </div>
                    <div class="form-group">
                        <label>Presupuesto</label>
                        <input type="number" id="newPresupuesto">
                    </div>
                </div>
                <div class="form-group">
                    <label>Tarea Inicial</label>
                    <textarea id="newObservacion" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Fecha de Revisi√≥n</label>
                    <input type="date" id="newFechaRevision">
                </div>
                <div style="text-align:center;">
                    <button type="submit" class="btn btn-success">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="siniestroSelectorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('siniestroSelectorModal')">&times;</span>
            <h2>üëÅÔ∏è Seleccionar Siniestro</h2>
            <div class="form-group">
                <select id="siniestroSelector" onchange="loadSiniestroInfo()">
                    <option value="">-- Seleccionar --</option>
                </select>
            </div>
        </div>
    </div>

    <div id="siniestroInfoModal" class="modal">
        <div class="modal-content"></div>
    </div>

    <div id="documentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('documentModal')">&times;</span>
            <h2 id="documentModalTitle"></h2>
            <ul id="documentList" class="document-list"></ul>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-info" onclick="triggerDocumentUpload()">‚ûï Subir Documento</button>
            </div>
        </div>
    </div>
    
    <script>
        // DATOS INICIALES (TU EXCEL)
        const initialData = [
            {"id":"SINIESTRO_1_1735933845000","fecha":"","cliente":"GONCALVES BEATRIZ","dni":"22108382","celular":"1164233680","aseguradoEn":"RIVADAVIA","contra":"ORBIS","numeroReclamo":"232644","observacion":"SE INFORMO A CLIENTE QUE NO SE DARA RESOLUCION POR ORBIS NO DA RESPUESTA","fechaRevision":"2025-01-15","estado":"RECHAZADO","acuerdo":"","fechaPago":"","presupuesto":1140000,"indemnizacion":"","honorarios":"","factura":"NO","observaciones":[{"id":"obs_1","fecha":"2024-12-30","texto":"SE INFORMO A CLIENTE QUE NO SE DARA RESOLUCION POR ORBIS NO DA RESPUESTA","proximaRevision":"2025-01-15","completed":false}]},
            {"id":"SINIESTRO_2_1735933845001","fecha":"2024-12-06","cliente":"GRANADO MIGUEL ANGEL","dni":"21543471","celular":"1173653571","aseguradoEn":"COPAN","contra":"ZURICH","numeroReclamo":"0","observacion":"SE INFOMO A CLIENTE QUE ZURICH NO CUBRE EL PARABRISAS","fechaRevision":"2025-01-20","estado":"RECHAZADO","acuerdo":"","fechaPago":"","presupuesto":285999.99,"indemnizacion":"","honorarios":"","factura":"NO","observaciones":[{"id":"obs_2","fecha":"2024-12-20","texto":"SE INFOMO A CLIENTE QUE ZURICH NO CUBRE EL PARABRISAS","proximaRevision":"2025-01-20","completed":false}]},
            {"id":"SINIESTRO_3_1735933845002","fecha":"","cliente":"SILGUEIRO VICTOR","dni":"34566518","celular":"","aseguradoEn":"FEDERACION","contra":"LA CAJA","numeroReclamo":"54000113645","observacion":"SE FUE CON NEMESIS","fechaRevision":"","estado":"RECHAZADO","acuerdo":"","fechaPago":"","presupuesto":1074000,"indemnizacion":"","honorarios":"","factura":"NO","observaciones":[{"id":"obs_3","fecha":"2024-12-26","texto":"SE FUE CON NEMESIS","proximaRevision":"","completed":true}]},
            {"id":"SINIESTRO_4_1735933845003","fecha":"","cliente":"GALEPPI SUSANA","dni":"11130200","celular":"1151388650","aseguradoEn":"GALENO","contra":"SAN CRIST√ìBAL","numeroReclamo":"UC368744","observacion":"NO HIZO LA DENUECIA LE 3RO","fechaRevision":"","estado":"RECHAZADO","acuerdo":"","fechaPago":"","presupuesto":530000,"indemnizacion":"","honorarios":"","factura":"NO","observaciones":[{"id":"obs_4","fecha":"2024-12-26","texto":"NO HIZO LA DENUECIA LE 3RO","proximaRevision":"","completed":true}]},
            {"id":"SINIESTRO_5_1735933845004","fecha":"2024-12-01","cliente":"ALVAREZ CLAUDIA","dni":"28456789","celular":"1145678901","aseguradoEn":"COPAN","contra":"FEDERACION","numeroReclamo":"CP2025001","observacion":"PERITAJE REALIZADO, ESPERANDO LIQUIDACION","fechaRevision":"2025-01-10","estado":"EJECUCION","acuerdo":"","fechaPago":"","presupuesto":890000,"indemnizacion":"","honorarios":"","factura":"NO","observaciones":[{"id":"obs_5","fecha":"2024-12-15","texto":"PERITAJE REALIZADO, ESPERANDO LIQUIDACION","proximaRevision":"2025-01-10","completed":false}]},
            {"id":"SINIESTRO_6_1735933845005","fecha":"2024-12-15","cliente":"RODRIGUEZ MARIA","dni":"32567890","celular":"1156789012","aseguradoEn":"FEDERACION","contra":"SANCOR","numeroReclamo":"FED2024089","observacion":"CASO FINALIZADO CON ACUERDO TOTAL","fechaRevision":"","estado":"FINALIZADA","acuerdo":"SI","fechaPago":"2025-01-15","presupuesto":1250000,"indemnizacion":1250000,"honorarios":187500,"factura":"SI","observaciones":[{"id":"obs_6","fecha":"2025-01-10","texto":"CASO FINALIZADO CON ACUERDO TOTAL","proximaRevision":"","completed":true}]},
            {"id":"SINIESTRO_7_1735933845006","fecha":"2024-11-20","cliente":"MARTINEZ CARLOS","dni":"29345678","celular":"1167890123","aseguradoEn":"RIVADAVIA","contra":"ZURICH","numeroReclamo":"RIV2024045","observacion":"FINALIZADO CON PAGO PARCIAL ACORDADO","fechaRevision":"","estado":"FINALIZADA P","acuerdo":"SI","fechaPago":"2024-12-25","presupuesto":2100000,"indemnizacion":1575000,"honorarios":236250,"factura":"SI","observaciones":[{"id":"obs_7","fecha":"2024-12-20","texto":"FINALIZADO CON PAGO PARCIAL ACORDADO","proximaRevision":"","completed":true}]},
            {"id":"SINIESTRO_8_1735933845007","fecha":"2025-01-10","cliente":"LOPEZ PATRICIA","dni":"30456789","celular":"1178901234","aseguradoEn":"COPAN","contra":"LA CAJA","numeroReclamo":"CP2025002","observacion":"DOCUMENTACION ADICIONAL SOLICITADA","fechaRevision":"2025-01-04","estado":"DEMORADA","acuerdo":"","fechaPago":"","presupuesto":675000,"indemnizacion":"","honorarios":"","factura":"NO","observaciones":[{"id":"obs_8","fecha":"2025-01-01","texto":"DOCUMENTACION ADICIONAL SOLICITADA","proximaRevision":"2025-01-04","completed":false}]},
            {"id":"SINIESTRO_9_1735933845008","fecha":"2024-10-15","cliente":"GARCIA FERNANDO","dni":"31567890","celular":"1189012345","aseguradoEn":"FEDERACION","contra":"ORBIS","numeroReclamo":"FED2024067","observacion":"PERITAJE FAVORABLE, EN LIQUIDACION","fechaRevision":"2025-01-03","estado":"EJECUCION","acuerdo":"","fechaPago":"","presupuesto":1450000,"indemnizacion":"","honorarios":"","factura":"NO","observaciones":[{"id":"obs_9","fecha":"2024-11-30","texto":"PERITAJE FAVORABLE, EN LIQUIDACION","proximaRevision":"2025-01-03","completed":false}]},
            {"id":"SINIESTRO_10_1735933845009","fecha":"2024-09-05","cliente":"FERNANDEZ ANA","dni":"27890123","celular":"1190123456","aseguradoEn":"RIVADAVIA","contra":"SANCOR","numeroReclamo":"RIV2024034","observacion":"RECHAZADO POR FALTA DE COBERTURA","fechaRevision":"","estado":"RECHAZADO","acuerdo":"","fechaPago":"","presupuesto":820000,"indemnizacion":"","honorarios":"","factura":"NO","observaciones":[{"id":"obs_10","fecha":"2024-10-15","texto":"RECHAZADO POR FALTA DE COBERTURA","proximaRevision":"","completed":true}]}
        ];
        
        let siniestrosData = [];
        let editingSiniestroId = null, editingField = null;

        function saveData() { 
            localStorage.setItem('planilla_siniestros_data', JSON.stringify(siniestrosData)); 
            updateDataStatus('‚úÖ Datos guardados'); 
        }
        
        function loadData() {
            const savedData = localStorage.getItem('planilla_siniestros_data');
            let data = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(initialData));
            siniestrosData = sanitizeData(data);
            if (!savedData && siniestrosData.length > 0) saveData();
            updateDataStatus(savedData ? '‚úÖ Datos cargados' : 'üìã Planilla lista con datos iniciales');
        }
        
        function sanitizeData(data) {
            let sanitized = false;
            data.forEach(s => {
                if (!s.id) { s.id = generateId(s); sanitized = true; }
                if (!s.observaciones) { s.observaciones = []; sanitized = true; }
                s.observaciones.forEach(obs => {
                    if (!obs.id) { obs.id = generateId({}); sanitized = true; }
                    if (typeof obs.completed === 'undefined') { obs.completed = false; sanitized = true; }
                });
